# =============================================================================
# Apache VirtualHost configuration for food-recipes
# Copy this file to: /etc/apache2/sites-available/recipes.ammiratafabiano.dev.conf
#
# Prerequisites:
#   sudo a2enmod proxy proxy_http proxy_wstunnel rewrite ssl
#   sudo certbot --apache -d recipes.ammiratafabiano.dev
#   sudo certbot --apache -d api.recipes.ammiratafabiano.dev
#   sudo systemctl restart apache2
# =============================================================================

<VirtualHost *:80>
    ServerName recipes.ammiratafabiano.dev
    ServerAlias api.recipes.ammiratafabiano.dev

    RewriteEngine on
    RewriteCond %{SERVER_NAME} =recipes.ammiratafabiano.dev [OR]
    RewriteCond %{SERVER_NAME} =api.recipes.ammiratafabiano.dev
    RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>

<IfModule mod_ssl.c>
    # ==========================================
    # FRONTEND - recipes.ammiratafabiano.dev
    # ==========================================
    <VirtualHost *:443>
        ServerName recipes.ammiratafabiano.dev

        ProxyPreserveHost On
        ProxyPass / http://127.0.0.1:8080/
        ProxyPassReverse / http://127.0.0.1:8080/

        SSLCertificateFile /etc/letsencrypt/live/recipes.ammiratafabiano.dev/fullchain.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/recipes.ammiratafabiano.dev/privkey.pem
        Include /etc/letsencrypt/options-ssl-apache.conf
    </VirtualHost>

    # ==========================================
    # BACKEND API - api.recipes.ammiratafabiano.dev
    # ==========================================
    <VirtualHost *:443>
        ServerName api.recipes.ammiratafabiano.dev

        ProxyPreserveHost On

        # WebSocket support for Socket.IO
        RewriteEngine On
        RewriteCond %{HTTP:Upgrade} =websocket [NC]
        RewriteRule /(.*)           ws://127.0.0.1:3010/$1 [P,L]
        RewriteCond %{HTTP:Upgrade} !=websocket [NC]
        RewriteRule /(.*)           http://127.0.0.1:3010/$1 [P,L]

        ProxyPassReverse / http://127.0.0.1:3010/

        SSLCertificateFile /etc/letsencrypt/live/api.recipes.ammiratafabiano.dev/fullchain.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/api.recipes.ammiratafabiano.dev/privkey.pem
        Include /etc/letsencrypt/options-ssl-apache.conf
    </VirtualHost>
</IfModule>
